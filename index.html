<html>
  <head>
    <meta charset="UTF-8">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">

      // Load Charts and the corechart and barchart packages.
      google.charts.load('current', {'packages':['corechart']});

      // Draw the pie chart and bar chart when Charts is loaded.
      google.charts.setOnLoadCallback(initialize);

      function initialize() {
        var queryOptions = {
          csvColumns: ['date', 'number', 'number', 'number', 'number', 'number', 'number', 'number', 'number'],
          csvHasHeader: true,
          sendMethod: 'auto'
        };
        // Replace the data source URL on next line with your data source URL.
        var query = new google.visualization.Query('https://ychenfr.github.io/covid-bretagne/data.csv', queryOptions);

        // for local dev & debug, use local data and serve this html on localhost
        <!-- var query = new google.visualization.Query('http://localhost:8080/data.csv', queryOptions);  -->
        // Optional request following the query language spec.
        query.setQuery('select *');
      
        // Send the query with a callback function.
        query.send(handleQueryResponse);
      }

      function handleQueryResponse(response) {

        if (response.isError()) {
          alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
          return;
        }
        var data = response.getDataTable();

        var view_day = new google.visualization.DataView(data);
        view_day.setColumns([0, 
          {type: 'number', calc: delta(4, 1), label: 'Ille-et-Vilaine(35)'},
          {type: 'number', calc: delta(3, 1), label: 'Morbihan (56)'},
          {type: 'number', calc: delta(5, 1), label: 'Finistère (29)'},
          {type: 'number', calc: delta(6, 1), label: "Côte d'armor (22)"},
          ])
        view_day.hideRows([0]);

        var view_week = new google.visualization.DataView(data);
        view_week.setColumns([0, 
          {type: 'number', calc: delta(4, 3), label: 'Ille-et-Vilaine(35)'},
          {type: 'number', calc: delta(3, 3), label: 'Morbihan (56)'},
          {type: 'number', calc: delta(5, 3), label: 'Finistère (29)'},
          {type: 'number', calc: delta(6, 3), label: "Côte d'armor (22)"},
          ])

        var view_2 = new google.visualization.DataView(data);
        view_2.setColumns([0, 
          {type: 'number', sourceColumn: 7, label: 'Hospitalisation'},
          {type: 'number', sourceColumn: 8, label: 'Réanimation'},
          ])

        var linechart_options_day = {
          'title': 'Nombre de Cas Confirmés par Département (par jour)', 
          width: 1200,
          height: 500,
          legend: { position: 'top', maxLines: 3 },
          hAxis: { format: 'MMM dd' },
        };

        var linechart_options_week = {
          'title': 'Nombre de Cas Confirmés par Département (7 jours glissants)', 
          width: 1200,
          height: 500,
          legend: { position: 'top', maxLines: 3 },
          hAxis: { format: 'MMM dd' },
        };

        var linechart_options_2 = {
          'title': 'Situation Hopital en Bretagne', 
          width: 1200,
          height: 500,
          legend: { position: 'top', maxLines: 3 },
          hAxis: { format: 'MMM dd' },
          isStacked: true,
        };

        var chart = new google.visualization.LineChart(document.getElementById('linechart_div_day'));
        chart.draw(view_day, linechart_options_day);

        var chart = new google.visualization.LineChart(document.getElementById('linechart_div_week'));
        chart.draw(view_week, linechart_options_week);

        var chart = new google.visualization.LineChart(document.getElementById('linechart_div_2'));
        chart.draw(view_2, linechart_options_2);
      
      }

      function delta(columnNum, ref) {
        function delta_column(dataTable, rowNum) { 
          if (rowNum - ref < 0) {
            return 0
          } else {
            return dataTable.getValue(rowNum, columnNum) - dataTable.getValue(rowNum-ref, columnNum)
          }
        }
        return delta_column
      }

      // https://developers.google.com/chart/interactive/docs/reference#google_visualization_data_group

</script>
<body>
    <!--Table and divs that hold the pie charts-->
    <table class="columns">
      <tr>
        <div id="linechart_div_day"></div>
      </tr>
      <tr>
        <div id="linechart_div_week"></div>
      </tr>
      <tr>
        <div id="linechart_div_2"></div>
      </tr>
    </table>
  </body>
</html>
